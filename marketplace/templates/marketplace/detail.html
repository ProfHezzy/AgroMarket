{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - AgroMarket{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="flex mb-8" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{% url 'core:home' %}" class="text-gray-700 hover:text-green-600">
                    <i class="fas fa-home mr-1"></i>
                    Home
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <a href="{% url 'marketplace:product_list' %}" class="text-gray-700 hover:text-green-600">Marketplace</a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <span class="text-gray-500">{{ product.name }}</span>
                </div>
            </li>
        </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Product Images -->
        <div class="space-y-4">
            <div class="aspect-square bg-gray-200 rounded-lg overflow-hidden">
                <div class="w-full h-full bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center">
                    <i class="fas fa-apple-alt text-6xl text-green-600"></i>
                </div>
            </div>
            <div class="grid grid-cols-4 gap-2">
                {% for i in "1234" %}
                    <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer hover:opacity-75 transition duration-200">
                        <div class="w-full h-full bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center">
                            <i class="fas fa-apple-alt text-2xl text-green-600"></i>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Product Info -->
        <div class="space-y-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ product.name }}</h1>
                <div class="flex items-center space-x-4 mb-4">
                    <div class="flex items-center">
                        <div class="flex text-yellow-400">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                        </div>
                        <span class="text-sm text-gray-600 ml-2">(4.5) • 23 reviews</span>
                    </div>
                    <span class="text-green-600 font-medium">In Stock</span>
                </div>
                <p class="text-3xl font-bold text-green-600">${{ product.price }}</p>
                <p class="text-gray-600">per lb</p>
            </div>

            <!-- Product Description -->
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Description</h3>
                <p class="text-gray-600">
                    Fresh, organic apples grown on our family farm using sustainable farming practices. 
                    These crisp, sweet apples are perfect for eating fresh, baking, or making juice. 
                    Harvested at peak ripeness and carefully selected for quality.
                </p>
            </div>

            <!-- Product Details -->
            <div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Product Details</h3>
                <dl class="grid grid-cols-1 gap-2">
                    <div class="flex justify-between">
                        <dt class="text-gray-600">Category:</dt>
                        <dd class="text-gray-900">Fresh Fruits</dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="text-gray-600">Origin:</dt>
                        <dd class="text-gray-900">Local Farm</dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="text-gray-600">Harvest Date:</dt>
                        <dd class="text-gray-900">This Week</dd>
                    </div>
                    <div class="flex justify-between">
                        <dt class="text-gray-600">Organic:</dt>
                        <dd class="text-green-600 font-medium">Yes</dd>
                    </div>
                </dl>
            </div>

            <!-- Quantity and Add to Cart -->
            <div class="space-y-4">
                <div>
                    <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                    <div class="flex items-center space-x-3">
                        <button id="decrease-quantity" class="bg-gray-200 hover:bg-gray-300 text-gray-700 w-10 h-10 rounded-md flex items-center justify-center transition duration-200">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" id="quantity" value="1" min="1" max="{{ product.quantity_available }}"
                               class="w-20 text-center border border-gray-300 rounded-md py-2 focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <button id="increase-quantity" class="bg-gray-200 hover:bg-gray-300 text-gray-700 w-10 h-10 rounded-md flex items-center justify-center transition duration-200">
                            <i class="fas fa-plus"></i>
                        </button>
                        <span class="text-gray-600">{{ product.unit }} available: {{ product.quantity_available }}</span>
                    </div>
                </div>

                <div class="flex space-x-4">
                    <button id="add-to-cart-btn" class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-700 transition duration-200" data-product-id="{{ product.id }}">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        Add to Cart
                    </button>
                    <button id="wishlist-btn" class="bg-gray-200 text-gray-700 py-3 px-6 rounded-lg hover:bg-gray-300 transition duration-200">
                        <i class="fas fa-heart"></i>
                    </button>
                </div>

                <button id="buy-now-btn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition duration-200" data-product-id="{{ product.id }}">
                    <i class="fas fa-bolt mr-2"></i>
                    Buy Now - ${{ product.price }}
                </button>
            </div>

            <!-- Seller Info -->
            <div class="border-t pt-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Seller Information</h3>
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                        <span class="text-white font-semibold">JF</span>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900">Johnson Family Farm</h4>
                        <div class="flex items-center space-x-2">
                            <div class="flex text-yellow-400">
                                <i class="fas fa-star text-sm"></i>
                                <i class="fas fa-star text-sm"></i>
                                <i class="fas fa-star text-sm"></i>
                                <i class="fas fa-star text-sm"></i>
                                <i class="fas fa-star text-sm"></i>
                            </div>
                            <span class="text-sm text-gray-600">(5.0) • 156 sales</span>
                        </div>
                        <p class="text-sm text-gray-600">Member since 2020</p>
                    </div>
                </div>
                <div class="mt-4 flex space-x-3">
                    <button class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition duration-200">
                        <i class="fas fa-store mr-2"></i>
                        View Store
                    </button>
                    <button class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300 transition duration-200">
                        <i class="fas fa-envelope mr-2"></i>
                        Contact Seller
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Customer Reviews</h2>
        
        <!-- Review Summary -->
        <div class="bg-gray-50 rounded-lg p-6 mb-6">
            <div class="flex items-center space-x-6">
                <div class="text-center">
                    <div class="text-4xl font-bold text-gray-900">4.5</div>
                    <div class="flex text-yellow-400 justify-center">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star-half-alt"></i>
                    </div>
                    <div class="text-sm text-gray-600">23 reviews</div>
                </div>
                <div class="flex-1">
                    {% for rating in "54321" %}
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-sm text-gray-600">{{ rating }}</span>
                            <i class="fas fa-star text-yellow-400 text-sm"></i>
                            <div class="flex-1 bg-gray-200 rounded-full h-2">
                                <div class="bg-yellow-400 h-2 rounded-full" style="width: {% if rating == '5' %}60{% elif rating == '4' %}30{% elif rating == '3' %}8{% else %}1{% endif %}%"></div>
                            </div>
                            <span class="text-sm text-gray-600">{% if rating == '5' %}14{% elif rating == '4' %}7{% elif rating == '3' %}2{% else %}0{% endif %}</span>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Individual Reviews -->
        <div class="space-y-6">
            {% for i in "123" %}
                <div class="border-b pb-6">
                    <div class="flex items-start space-x-4">
                        <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
                            <span class="text-gray-600 font-semibold">{{ i|add:"A" }}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-2">
                                <h4 class="font-semibold text-gray-900">Customer {{ i }}</h4>
                                <div class="flex text-yellow-400">
                                    <i class="fas fa-star text-sm"></i>
                                    <i class="fas fa-star text-sm"></i>
                                    <i class="fas fa-star text-sm"></i>
                                    <i class="fas fa-star text-sm"></i>
                                    <i class="fas fa-star text-sm"></i>
                                </div>
                                <span class="text-sm text-gray-500">2 days ago</span>
                            </div>
                            <p class="text-gray-600">
                                Excellent quality apples! Fresh, crisp, and exactly as described. 
                                The packaging was great and delivery was fast. Will definitely order again.
                            </p>
                            <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                                <button class="hover:text-green-600">
                                    <i class="fas fa-thumbs-up mr-1"></i>
                                    Helpful ({{ i|add:2 }})
                                </button>
                                <button class="hover:text-red-600">
                                    <i class="fas fa-flag mr-1"></i>
                                    Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="text-center mt-6">
            <button class="bg-gray-200 text-gray-700 py-2 px-6 rounded-md hover:bg-gray-300 transition duration-200">
                Load More Reviews
            </button>
        </div>
    </div>

    <!-- Related Products -->
    <div class="mt-12">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Related Products</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for i in "1234" %}
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition duration-300">
                    <div class="relative">
                        <div class="w-full h-48 bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center">
                            <i class="fas fa-apple-alt text-4xl text-green-600"></i>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Related Product {{ i }}</h3>
                        <div class="flex items-center justify-between">
                            <span class="text-xl font-bold text-green-600">${{ i }}9.99</span>
                            <button class="bg-green-600 text-white py-1 px-3 rounded-md hover:bg-green-700 transition duration-200" data-product-id="{{ i }}">
                                Add to Cart
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Product detail page functionality
let isInWishlist = false;

// Add event listeners when page loads
document.addEventListener('DOMContentLoaded', function() {
    const quantityInput = document.getElementById('quantity');
    const decreaseButton = document.getElementById('decrease-quantity');
    const increaseButton = document.getElementById('increase-quantity');
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    const wishlistBtn = document.getElementById('wishlist-btn');
    const buyNowBtn = document.getElementById('buy-now-btn');
    
    // Add to cart functionality
    addToCartBtn.addEventListener('click', function() {
        const quantity = parseInt(quantityInput.value);
        const productName = document.querySelector('h1').textContent;
        const priceText = document.querySelector('.text-3xl.font-bold.text-green-600').textContent;
        const price = parseFloat(priceText.replace('$', '').replace(',', ''));
        const productId = this.dataset.productId || '1'; // Default to 1 if not set
        
        // Show loading state
        const originalContent = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Adding...';
        this.disabled = true;
        
        // Send AJAX request to backend
        fetch('/cart/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                product_id: productId,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success notification
                AgroMarket.showNotification(`${quantity} x ${productName} added to cart!`, 'success');
                
                // Update cart count in header
                updateCartCount(data.cart_count);
            } else {
                // Show error notification
                AgroMarket.showNotification(`❌ Error: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error adding to cart:', error);
            AgroMarket.showNotification('❌ Error adding to cart. Please try again.', 'error');
        })
        .finally(() => {
            // Reset button
            this.innerHTML = originalContent;
            this.disabled = false;
        });
    });
    
    // Wishlist functionality
    wishlistBtn.addEventListener('click', function() {
        const heart = this.querySelector('.fa-heart');
        const productName = document.querySelector('h1').textContent;
        
        if (isInWishlist) {
            // Remove from wishlist
            heart.classList.remove('text-red-500');
            heart.classList.add('text-gray-700');
            this.classList.remove('bg-red-100', 'text-red-700');
            this.classList.add('bg-gray-200', 'text-gray-700');
            AgroMarket.showNotification(`${productName} removed from wishlist`, 'info');
            isInWishlist = false;
        } else {
            // Add to wishlist
            heart.classList.remove('text-gray-700');
            heart.classList.add('text-red-500');
            this.classList.remove('bg-gray-200', 'text-gray-700');
            this.classList.add('bg-red-100', 'text-red-700');
            AgroMarket.showNotification(`${productName} added to wishlist`, 'success');
            isInWishlist = true;
        }
    });
    
    // Buy Now functionality
    buyNowBtn.addEventListener('click', function() {
        const quantity = parseInt(quantityInput.value);
        const productId = this.dataset.productId;
        
        if (!productId) {
            AgroMarket.showNotification('❌ Product not found. Please refresh the page.', 'error');
            return;
        }
        
        // Show loading state
        const originalContent = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        this.disabled = true;
        
        // Redirect to checkout with product info
        const checkoutUrl = `/payments/checkout/?buy_now=true&product_id=${productId}&quantity=${quantity}`;
        window.location.href = checkoutUrl;
    });
    
    // Quantity controls
    decreaseButton.addEventListener('click', function() {
        const currentValue = parseInt(quantityInput.value);
        if (currentValue > 1) {
            quantityInput.value = currentValue - 1;
        }
    });
    
    increaseButton.addEventListener('click', function() {
        const currentValue = parseInt(quantityInput.value);
        const maxValue = parseInt(quantityInput.max); // Use max attribute
        if (currentValue < maxValue) {
            quantityInput.value = currentValue + 1;
        }
    });
    
    // Validate quantity input
    quantityInput.addEventListener('input', function() {
        const value = parseInt(this.value);
        if (isNaN(value) || value < 1) {
            this.value = 1;
        } else if (value > parseInt(this.max)) { // Use max attribute
            this.value = parseInt(this.max);
            AgroMarket.showNotification('Maximum quantity is ' + parseInt(this.max), 'warning');
        }
    });
    
    // Related products functionality
    document.querySelectorAll('.grid .bg-green-600').forEach((button, index) => {
        if (button.textContent.includes('Add to Cart')) {
            button.addEventListener('click', function() {
                const card = this.closest('.bg-white');
                const productName = card.querySelector('h3').textContent;
                const priceText = card.querySelector('.text-green-600').textContent;
                const price = parseFloat(priceText.replace('$', '').replace(',', ''));
                const productId = this.dataset.productId || (index + 1).toString();
                
                // Show loading state
                const originalContent = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                this.disabled = true;
                
                // Send AJAX request to backend
                fetch('/cart/add/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        quantity: 1
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        AgroMarket.showNotification(`${productName} added to cart!`, 'success');
                        updateCartCount(data.cart_count);
                    } else {
                        AgroMarket.showNotification(`❌ Error: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error adding to cart:', error);
                    AgroMarket.showNotification('❌ Error adding to cart. Please try again.', 'error');
                })
                .finally(() => {
                    this.innerHTML = originalContent;
                    this.disabled = false;
                });
            });
        }
    });
    
    // Review helpful buttons
    document.querySelectorAll('.fa-thumbs-up').forEach(button => {
        button.parentElement.addEventListener('click', function() {
            const countSpan = this.querySelector('span');
            const currentCount = parseInt(countSpan.textContent.match(/\d+/)[0]);
            countSpan.textContent = countSpan.textContent.replace(/\d+/, currentCount + 1);
            this.classList.add('text-green-600');
            AgroMarket.showNotification('Thank you for your feedback!', 'success');
        });
    });
    
    // Helper functions
    function updateCartCount(count) {
        const cartCount = document.getElementById('cart-count');
        if (cartCount) {
            cartCount.textContent = count;
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}